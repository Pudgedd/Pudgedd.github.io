---
title: Redis数据结构与对象(5)——整数集合
categories: Redis
tags: 
    - Redis
    - 数据结构
    - intset
---

## 整数集合
整数集合
: (intset)是**集合键（set）**的底层实现之一，当一个集合只包含整数值元素（浮点数会让set的object encoding 变成hashtable），并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合键的底层实现。
<!-- more -->

    redis> SADD numbers 1 3 4 5
    "4"
    reids> OBJECT ENCODING numbers
    "intset"
    redis> SADD numbers 1.1
    "1"
    redis> OBJECT ENCODING numbers
    "hashtable"

### 整数集合的实现
整数集合是Redis用于保存整数值的集合抽象数据结构，可以保存类型为`int16_t`、`int32_t`、`int64_t`的整数值，并且保证集合中不会出现重复元素。

整数集合
: 
``` c
typedef struct intset {
    uint32_t encoding; //编码方式
    uint32_t length; //集合包含的元素数量
    int8_t contents[]; //保存元素的数组
} intset;
```

contents数组是整数集合的底层实现：整数集合的每个元素都是`contents`数组的一个数组项（item），各个项在数组中按值的大小从小到大有序地排列，并且数组中不包含任何重复项。
虽然intset将contents属性声明为int8_t类型数组，但实际上`contents`数组并并不保存任何`int8_t`类型的值，contents数组的真正类型取决于`encoding`属性的值，即如果`encoding`属性的值为`INTSET_ENC_INT16`，那么`contents`就是一个`int16_t`类型的数组，数组里每个元素占16位。

#### 升级
每当我们要将一个新元素添加到整数集合里面，并且新元素的类型比整数集合现有所有元素的类型都要长时，整数集合需要先进行升级（upgrade），然后才能将新元素添加到整数集合里面。升级并添加分为三步进行：
1. 根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间
2. 将底层数组现有的所有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性质不变
3. 将新元素添加到底层数组里面

举个例子：有一个`INTSET_ENC_INT16`编码的整数集合，集合中有1，2，3这三个`int16_t`的元素，底层数组的大小为`3*16=48`位。若把`int32_t`类型的65535添加到集合中，必须要对整个集合进行升级。首先要分配四个元素的空间，即`36*4=128`位。接下来把三个元素转换成`int32_t`类型，并放置到正确位上面，且维持有序性不变。最后将第四个元素加入，将整数集合encoding属性值从`INTSET_ENC_INT16`改为`INTSET_ENC_INT32`，并将`length`属性的值从3改为4。

因为每次向整数集合添加新元素都可能会引起升级，而每次升级都需要对底层数组中已有的所有元素进行类型转换，所以向整数集合添加新元素的时间复杂度为`O(N)`。

升级的好处：
1. 提升灵活性：因为C是静态类型语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。但是，因为整数集合可以通过自动升级底层数组来适应新元素，所以我们可以随意将`int16_t`、`int32_t`、`int64_t`的整数添加到集合中，而不必担心出现类型错误
2. 节约内存：当然，要让有一个数组可以同时保存`int16_t`、`int32_t`、`int64_t`的整数最简单的做法就是直接使用`int64_t`类型的数组作为整数集合的底层实现。不过这样一来会造成内存浪费的情况，而整数集合现在的做法既可以让集合能同时保存三种不同类型的值，又可以确保升级操作只会在有需要的时候进行，这可以尽量节省内存。

### 降级
整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持在升级后的状态。

### 总结
- 整数集合是集合键的底层实现之一
- 整数集合的底层实现为数组，这个数组以有序、无重复的方式保存集合元素，在有需要时，程序会根据新添加元素的类型，改变这个数组的类型
- 升级操作为整数集合带来了操作上的灵活性，并且尽可能节约了内存
- 整数集合只支持升级操作，不支持降级操作